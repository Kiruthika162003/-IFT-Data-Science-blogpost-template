---
layout: post

title: A brief tutorial on downloading the NHL PlaybyPlay dataset
---

### The Question

Write a brief tutorial on how your team downloaded the dataset. Imagine :) that you were searching for a guide on how to download the play-by-play data; your guide should make you go “Perfect - this is exactly what I was looking for!”. Include your function/class, and provide an example of using it. Please ensure you’re not just demonstrating that your functionality works - this is also an exercise in documenting and communicating your implementation. It does not need to be extremely complicated, but we expect something slightly more coherent and digestible than just screenshots of your functions/code.

### The Steps
This tutorial focuses on how to fetch NHL play-by-play data from the NHL's API, handle potential errors, and store the data locally. The programming language used is Python.

* Step 1: Importing Libraries
```python
import os
import requests
import json
```
**`os`**: Used for interacting with the operating system (e.g., creating directories).  
**`requests`**: This library is essential for making HTTP requests to the NHL API.  
**`json`**: This library is used to work with the JSON data format, which is how the API provides the data.

* Step 2: Creating the **`fetch_nhl_play_by_play_data`** Function
```python
def fetch_nhl_play_by_play_data(season, game_type, game_number):
    """
    Fetch NHL play-by-play data for a given game in a season.

    Args:
        season (int): The starting year of the NHL season (e.g., 2016 for the 2016-17 season).
        game_type (str): The type of game (e.g., "01" for preseason, "02" for regular, "03" for playoffs).
        game_number (str): The specific game number, padded appropriately.

    Returns:
        dict: JSON data of the play-by-play for the specified game, or None if not found.
    """
    game_id = f"{season}{game_type}{game_number}"
    url = f"https://api-web.nhle.com/v1/gamecenter/{game_id}/play-by-play"

    try:
        response = requests.get(url)
        response.raise_for_status()  # Raise an error for bad responses (e.g., 404)
        data = response.json()
        return data
    except requests.exceptions.HTTPError as errh:
        if response.status_code == 404:
            print(f"Game ID {game_id} not found (404). Skipping.")
        else:
            print("HTTP Error:", errh)
    except requests.exceptions.RequestException as err:
        print("Request Error:", err)
        return None
```
__Constructing the API URL:__
It takes the `season`, `game_type`, and `game_number` as input.
It constructs the `game_id` and the API URL using f-strings for easy formatting:
```python
game_id = f"{season}{game_type}{game_number}"
url = f"https://api-web.nhle.com/v1/gamecenter/{game_id}/play-by-play"
```
__Making the Request:__
It uses `requests.get(url)` to send a GET request to the API endpoint:
```python
response = requests.get(url)
```
__Error Handling:__
A **`try...except`** block handles potential errors during the request: 
```python
try:
    response = requests.get(url)
    response.raise_for_status()  # Raise an error for bad responses (e.g., 404)
    data = response.json()
    return data
except requests.exceptions.HTTPError as errh:
    if response.status_code == 404:
        print(f"Game ID {game_id} not found (404). Skipping.")
    else:
        print("HTTP Error:", errh)
except requests.exceptions.RequestException as err:
    print("Request Error:", err)
    return None
```
__Returning Data:__
If the request is successful, it parses the JSON response using `response.json()` and returns the data.

* Step 3: Creating the **`save_data_to_file`** Function
```python
def save_data_to_file(data, file_path):
    """
    Save fetched data to a JSON file.

    Args:
        data (dict): The JSON data to save.
        file_path (str): The file path to save the data to.
    """
    if data:
        with open(file_path, 'w') as file:
            json.dump(data, file, indent=4)
        print(f"Data saved to {file_path}")
    else:
        print("No data to save.")
```
This function takes the **`data`** to be saved and the **`file_path`** as arguments.
It opens the file in write mode (**`'w'`**) and uses **`json.dump()`** to save the data in JSON format with an indent for readability.

* Step 4: The Main Execution (if __name__ == "__main__":)
```python
if __name__ == "__main__":
  # Iterate over each season from 2016 to 2024
  for year in range(2016, 2016):
      for game_type in ["02", "03"]:
          if game_type == "02":
              game_numbers = list(range(1, 1272))
          else:
              game_numbers = list(range(1, 132))

          for game_num in game_numbers:
              if game_type == "03":  # Special formatting for playoff games
                  game_id_str = f"0{str(game_num).zfill(3)}"  # Pad with a leading zero, followed by 3 digits (e.g., "0001" -> "00001")
              else:
                  game_id_str = str(game_num).zfill(4)  # Zero-pad game number to 4 digits

              data_folder = os.getenv("NHL_DATA_FOLDER", "./nhl_data")  # Default to local folder if env variable not set
              os.makedirs(data_folder, exist_ok=True)

              file_path = os.path.join(data_folder, f"game_{year + 1}_{game_type}_{game_id_str}.json")

              # Check if data already exists locally
              if os.path.exists(file_path):
                  print(f"Data already exists for game {year + 1}-{game_type}-{game_id_str}. Skipping download.")
                  continue

              # Fetch and save data
              data = fetch_nhl_play_by_play_data(year, game_type, game_id_str)
              if data:
                  save_data_to_file(data, file_path)
```
__Setting up the Data Directory:__
It gets the data folder path from the `NHL_DATA_FOLDER` environment variable or defaults to `"./nhl_data"`.  
It creates the data directory if it doesn't exist using `os.makedirs(data_folder, exist_ok=True)`.
```
```
__Iterating Through Games:__
It iterates through years (only 2016 in this case), game types (`"02"` for regular season, `"03"` for playoffs), and game numbers.
It formats the game_id_str differently for playoff games.
```
```
__Checking for Existing Data:__
It constructs the `file_path` where the data will be saved.
It checks if the file already exists at that path. If it does, it skips downloading the data.
```
```
__Fetching and Saving:__
It calls `fetch_nhl_play_by_play_data` to get the data.
It calls `save_data_to_file` to save the data if it was successfully fetched.
```